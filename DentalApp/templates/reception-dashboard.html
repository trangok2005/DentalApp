{% extends "layout/base.html" %}

{% block title %}
Quản Lý Lịch Hẹn | Phòng Khám Nha Khoa
{% endblock %}

{% block content %}
<div class="container-fluid py-4">

    <div class="row mb-4 align-items-center">
        <div class="col-md-6">
            <h2 class="fw-bold text-primary"><i class="fas fa-clipboard-list me-2"></i>Danh Sách Chờ Khám</h2>

        </div>
        <div class="col-md-6 text-end">
            <a href="/booking" class="btn btn-success btn-lg shadow-sm">
                <i class="fas fa-plus-circle me-2"></i>Đặt Lịch Mới
            </a>
        </div>
    </div>

    <div class="card shadow-sm mb-4 border-0">
        <div class="card-body bg-light rounded">
            <form method="GET" action="" class="row g-3">
                <input type="hidden" name="active_tab" value="{{ active_tab }}">
                <div class="col-md-3">
                    <label class="form-label fw-bold">Ngày khám</label>
                    <input type="date" name="date" class="form-control" value="{{ selected_date }}">
                </div>

                <div class="col-md-3">
                    <label class="form-label fw-bold">Bác sĩ</label>
                    <select name="doctor_id" class="form-select">
                        <option value="">-- Tất cả bác sĩ --</option>
                        {% for ns in ds_nhasi %}
                        <option value="{{ ns.MaNguoiDung }}" {% if selected_doctor== ns.MaNguoiDung %}selected{% endif
                                %}>
                            {{ ns }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label fw-bold">Tìm bệnh nhân (Tên/SĐT)</label>
                    <div class="input-group">
                        <span class="input-group-text bg-white"><i class="fas fa-search text-muted"></i></span>
                        <input type="text" name="keyword" class="form-control" placeholder="Nhập tên hoặc SĐT..."
                               value="{{ keyword }}">
                    </div>
                </div>

                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100"><i class="fas fa-filter me-2"></i>Lọc</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow border-0">
        <div class="card-header bg-white border-bottom-0 pb-0">
            <ul class="nav nav-tabs card-header-tabs" id="dashboardTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link fw-bold text-primary {% if active_tab == 'appointment' %}active{% endif %}"
                            id="appointment-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#appointment-pane"
                            type="button"
                            role="tab"
                            aria-selected="{{ 'true' if active_tab == 'appointment' else 'false' }}">
                        <i class="fas fa-calendar-check me-2"></i>Lịch Hẹn Khám
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link fw-bold text-success {% if active_tab == 'payment' %}active{% endif %}"
                            id="payment-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#payment-pane"
                            type="button"
                            role="tab"
                            aria-selected="{{ 'true' if active_tab == 'payment' else 'false' }}">
                        <i class="fas fa-file-invoice-dollar me-2"></i>Thanh Toán Viện Phí
                    </button>
                </li>
            </ul>
        </div>

        <div class="card-body p-0">
            <div class="tab-content" id="dashboardTabsContent">

                <div class="tab-pane fade show active {% if active_tab == 'payment' %}show active{% endif %}"
                     id="appointment-pane" role="tabpanel">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light">
                            <tr>
                                <th class="py-3 ps-4">Giờ hẹn</th>
                                <th class="py-3">Bệnh Nhân</th>
                                <th class="py-3">Bác Sĩ</th>
                                <th class="py-3">Trạng Thái</th>
                                <th class="py-3">Ghi Chú</th>
                                <th class="py-3 text-end pe-4">Hành Động</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% if ds_lichhen %}
                            {% for lh in ds_lichhen %}
                            <tr>
                                <td class="ps-4">
                                    <div class="fw-bold">{{ lh.GioKham.strftime('%H:%M') }}</div>
                                    <small class="text-muted">{{ lh.NgayKham.strftime('%d/%m/%Y') }}</small>
                                </td>
                                <td>
                                    <div class="fw-bold">{{ lh.benhnhan.HoTen }}</div>
                                    <small class="text-muted">{{ lh.benhnhan.SDT }}</small>
                                </td>
                                <td>{{ lh.nhasi.HoTen }}</td>
                                <td>
                                <span class="badge
                                    {% if lh.TrangThai.value == 'Chờ Khám' %}bg-warning text-dark
                                    {% elif lh.TrangThai.value == 'Đã Khám' %}bg-success
                                    {% elif lh.TrangThai.value == 'Hủy' %}bg-secondary
                                    {% endif %}">
                                    {{ lh.TrangThai.value }}
                                </span>
                                </td>
                                <td class="text-muted text-truncate" style="max-width: 150px;">
                                    {{ lh.GhiChu or '---' }}
                                </td>
                                <td class="text-end pe-4">
                                    {# CHỈ CÒN NÚT HỦY CHO TRẠNG THÁI CHỜ #}
                                    {% if lh.TrangThai.value == 'Chờ Khám' %}
                                    <button type="button" class="btn btn-outline-danger btn-sm js-cancel-btn"
                                            data-id="{{ lh.MaLH }}" data-name="{{ lh.benhnhan.HoTen }}">
                                        <i class="fas fa-times"></i> Hủy
                                    </button>
                                    {% if lh.is_late %}
                                    <span class="badge bg-danger ms-1">Trễ</span>
                                    {% endif %}
                                    {% elif lh.TrangThai.value == 'Đã Khám' %}
                                    <span class="text-success"><i class="fas fa-check"></i> Đã khám xong</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="6" class="text-center py-4">Không có lịch hẹn.</td>
                            </tr>
                            {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-pane fade" id="payment-pane" role="tabpanel">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light">
                            <tr>
                                <th class="py-3 ps-4">Mã HĐ</th>
                                <th class="py-3">Bệnh Nhân</th>
                                <th class="py-3">Tổng Tiền</th>
                                <th class="py-3">Trạng Thái</th>
                                <th class="py-3">Ngày Lập</th>
                                <th class="py-3 text-end pe-4">Thao Tác</th>
                            </tr>
                            </thead>

                            <tbody id="invoice-table-body">
                            <tr>
                                <td colspan="6" class="text-center py-5 text-muted">
                                    <div class="spinner-border text-primary mb-2" role="status"></div>
                                    <p>Đang tải dữ liệu thanh toán...</p>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="modal fade" id="cancelModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="POST" action="/cancel-appointment">

                    <div class="modal-header">
                        <h5 class="modal-title text-danger">Xác nhận hủy lịch</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="modal-body">
                        <p>
                            Bạn có chắc chắn muốn hủy lịch hẹn của bệnh nhân: <br>
                            <strong id="modalPatientName" class="text-primary" style="font-size: 1.2rem;"></strong>
                        </p>
                        <input type="hidden" name="ma_lh" id="modalApptId">

                        <input type="hidden" name="current_date" value="{{ selected_date }}">
                        <input type="hidden" name="current_doctor" value="{{ selected_doctor or '' }}">
                        <input type="hidden" name="current_keyword" value="{{ keyword }}">

                        <div class="mb-3">
                            <label class="form-label">Lý do hủy:</label>
                            <select name="ly_do" class="form-select" required>
                                <option value="Khách yêu cầu">Khách yêu cầu hủy</option>
                                <option value="Quá hẹn (No-show)">Khách không đến (Quá hẹn)</option>
                                <option value="Bác sĩ bận">Bác sĩ bận đột xuất</option>
                            </select>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                        <button type="submit" class="btn btn-danger">Xác nhận Hủy</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/reception-dashboard.js') }}"></script>
{% endblock %}