{% extends 'layout/base.html' %}
{% block title %}Báo cáo doanh thu{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center text-primary mb-4 fw-bold">BÁO CÁO THỐNG KÊ DOANH THU</h2>

    <div class="row">
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <i class="bi bi-funnel"></i> Bộ Lọc
                </div>
                <div class="card-body">
                    <form id="filterForm">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Tiêu chí thống kê:</label>
                            <select class="form-select" id="criteriaSelect">
                                <option value="month">Theo Tháng (Xu hướng năm)</option>
                                <option value="dentist">Theo Bác Sĩ</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Chọn Năm:</label>
                            <input type="number" class="form-control" id="yearInput" value="2025">
                        </div>

                        <div class="mb-3" id="monthFilterGroup" style="display:none;">
                            <label class="form-label">Chọn Tháng (Để trống = Cả năm):</label>
                            <select class="form-select" id="monthInput">
                                <option value="">-- Cả năm --</option>
                                {% for i in range(1, 13) %}
                                <option value="{{ i }}">Tháng {{ i }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <button type="button" onclick="loadChartData()" class="btn btn-success w-100">
                            <i class="bi bi-graph-up"></i> Xem Báo Cáo
                        </button>
                    </form>
                </div>
            </div>
            
            <div class="card shadow-sm mt-3 bg-light">
                <div class="card-body text-center">
                    <h6 class="text-muted">Tổng doanh thu hiển thị</h6>
                    <h4 class="text-danger fw-bold" id="totalRevenueDisplay">0 VNĐ</h4>
                </div>
            </div>
        </div>

        <div class="col-md-9">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Logic Javascript xử lý biểu đồ
    let myChart = null;

    // 1. Xử lý ẩn hiện ô chọn tháng
    document.getElementById('criteriaSelect').addEventListener('change', function() {
        const type = this.value;
        const monthGroup = document.getElementById('monthFilterGroup');
        if (type === 'dentist') {
            monthGroup.style.display = 'block';
        } else {
            monthGroup.style.display = 'none';
            document.getElementById('monthInput').value = ""; // Reset
        }
    });

    // 2. Hàm load dữ liệu và vẽ
    async function loadChartData() {
        const criteria = document.getElementById('criteriaSelect').value;
        const year = document.getElementById('yearInput').value;
        const month = document.getElementById('monthInput').value;

        try {
            const res = await fetch('/api/revenue-stats', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ criteria, year, month })
            });
            
            const data = await res.json();
            
            if (data.success) {
                renderChart(data.chartData, criteria);
                
                // Tính tổng hiển thị
                const total = data.chartData.data.reduce((a, b) => a + b, 0);
                document.getElementById('totalRevenueDisplay').innerText = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(total);
            } else {
                alert("Lỗi tải dữ liệu: " + data.message);
            }
        } catch (err) {
            console.error(err);
            alert("Lỗi kết nối server");
        }
    }

    // 3. Hàm vẽ biểu đồ dùng Chart.js
    function renderChart(chartData, criteria) {
        const ctx = document.getElementById('revenueChart').getContext('2d');
        const labelText = criteria === 'month' ? 'Doanh thu theo Tháng (VNĐ)' : 'Doanh thu theo Bác sĩ (VNĐ)';
        const barColor = criteria === 'month' ? 'rgba(54, 162, 235, 0.6)' : 'rgba(255, 99, 132, 0.6)';

        // Hủy biểu đồ cũ nếu có để vẽ mới
        if (myChart) {
            myChart.destroy();
        }

        myChart = new Chart(ctx, {
            type: 'bar', // Biểu đồ cột
            data: {
                labels: chartData.labels,
                datasets: [{
                    label: labelText,
                    data: chartData.data,
                    backgroundColor: barColor,
                    borderColor: barColor.replace('0.6', '1'),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            // Format tiền tệ trục Y
                            callback: function(value) {
                                return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', maximumSignificantDigits: 3 }).format(value);
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    // Load mặc định khi vào trang
    document.addEventListener('DOMContentLoaded', () => {
        loadChartData();
    });
</script>
{% endblock %}